<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Juan Lozano Vallejo">
<meta name="dcterms.date" content="2024-08-23">

<title>Population Trend Plots in ggplot2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="03_pop_lines_files/libs/clipboard/clipboard.min.js"></script>
<script src="03_pop_lines_files/libs/quarto-html/quarto.js"></script>
<script src="03_pop_lines_files/libs/quarto-html/popper.min.js"></script>
<script src="03_pop_lines_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="03_pop_lines_files/libs/quarto-html/anchor.min.js"></script>
<link href="03_pop_lines_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="03_pop_lines_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="03_pop_lines_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="03_pop_lines_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="03_pop_lines_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#the-process" id="toc-the-process" class="nav-link" data-scroll-target="#the-process"><span class="header-section-number">2</span> The Process</a>
  <ul class="collapse">
  <li><a href="#gathering-and-cleaning-data" id="toc-gathering-and-cleaning-data" class="nav-link" data-scroll-target="#gathering-and-cleaning-data"><span class="header-section-number">2.1</span> Gathering and Cleaning Data</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization"><span class="header-section-number">2.2</span> Visualization</a></li>
  </ul></li>
  <li><a href="#the-end-result" id="toc-the-end-result" class="nav-link" data-scroll-target="#the-end-result"><span class="header-section-number">3</span> The End Result</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">4</span> Next Steps</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Population Trend Plots in ggplot2</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Juan Lozano Vallejo </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 23, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>A couple of years ago I worked with <a href="https://www.gob.mx/conapo/documentos/reconstruccion-y-proyecciones-de-la-poblacion-de-los-municipios-de-mexico-1990-2040">CONAPO’s population projections</a> and found the process very slow and tedious because there wasn’t or I couldn’t find a good file to work with. Recently, I went back to the source and –probably because my search was better, or maybe they changed they files– found the information much more accessible this time around.</p>
<p>As I have been playing with the idea of creating reports for the municipalities of Mexico, after having edited the function for <a href="https://github.com/juanllave/mexico_pop/tree/main?tab=readme-ov-file">population pyramids</a>, I decided that a good next step would be to create a line plot that visualizes the trends in the population per municipality from 1990 to 2040.</p>
</section>
<section id="the-process" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="the-process"><span class="header-section-number">2</span> The Process</h2>
<section id="gathering-and-cleaning-data" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="gathering-and-cleaning-data"><span class="header-section-number">2.1</span> Gathering and Cleaning Data</h3>
<p>As always, the fist step is to load the libraries and do some house cleaning.</p>
<div class="cell">
<details class="code-fold">
<summary>Libraries</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># Set working directory</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">setwd</span>(<span class="st">'~/Documents/repos/R/mexico_pop'</span>)</span>
<span id="cb1-8"><a href="#cb1-8"></a>dir  <span class="ot">&lt;-</span> <span class="fu">getwd</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Afterwards, we retrieve the data. Upon loading, we remove unnecessary columns from the original dataset using select. The columns we are removing present the data by age groups, if we wished to create more complex plots that show the population changing by this measure, we could leave them, but for now, these will not be necessary.</p>
<div class="cell">
<details class="code-fold">
<summary>Load Data</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Load dataset with the population per municipality, age groups, and sex</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">paste0</span>(dir,<span class="st">'/datasets/1_Grupo_Quinq_00_RM.xlsx'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="dv">7</span><span class="sc">:</span><span class="dv">24</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once we have the data, we need to make a few adjustments, remove some columns and create new ones to be able to produce the plots.But before doing so, we need to create the variable <code>curent year</code> to store the value of the present year, this will future-proof the plots.</p>
<p>One more change we do before proceeding with the actual cleaning of the dataset, is translating the columns names from Spanish into English. For this, we create a vector with the new names for the columns and we change the names of the columns.</p>
<p>We are now ready to clean the dataset. Since the data is separated by women and men, and we need the total, we group the data and then summarize to have one value per municipality and per year. Next, we create columns with the population total for 1990, the current year, and 2040. These are immediately used to compute the percent change between 1990 and the current year, between 2040 and the current year, and between 1990 and 2040. Lastly, we create the columns <em>period</em> and <em>trend</em>, these will be helpful to choose the colors for the plots.</p>
<div class="cell">
<details class="code-fold">
<summary>Clean-up</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Create a value with the current year</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>current_year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y"</span>))</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># Create a vector to translate columns names into English</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>columns <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'key'</span>, <span class="st">'key_state'</span>, <span class="st">'state'</span>, <span class="st">'mun'</span>, <span class="st">'sex'</span>, <span class="st">'year'</span>, <span class="st">'total'</span>)</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># Change the columns names</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> columns</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"># Prepare the data for the plots</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>pop <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb3-12"><a href="#cb3-12"></a>  <span class="fu">group_by</span>(key, key_state, state, mun, year) <span class="sc">%&gt;%</span> </span>
<span id="cb3-13"><a href="#cb3-13"></a>  <span class="fu">summarise</span>(<span class="at">total =</span> <span class="fu">sum</span>(total)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-14"><a href="#cb3-14"></a>  <span class="fu">group_by</span>(key) <span class="sc">%&gt;%</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="at">pop_1990 =</span> total[year <span class="sc">==</span> <span class="dv">1990</span>],</span>
<span id="cb3-17"><a href="#cb3-17"></a>         <span class="at">pop_current =</span> total[year <span class="sc">==</span> current_year],</span>
<span id="cb3-18"><a href="#cb3-18"></a>         <span class="at">pop_2040 =</span> total[year <span class="sc">==</span> <span class="dv">2040</span>],</span>
<span id="cb3-19"><a href="#cb3-19"></a>         <span class="at">change_1990_current =</span> <span class="fu">round</span>((pop_current <span class="sc">-</span> pop_1990) <span class="sc">/</span> pop_1990,<span class="dv">5</span>),</span>
<span id="cb3-20"><a href="#cb3-20"></a>         <span class="at">change_current_2040 =</span> <span class="fu">round</span>((pop_2040 <span class="sc">-</span> pop_current) <span class="sc">/</span> pop_current,<span class="dv">5</span>),</span>
<span id="cb3-21"><a href="#cb3-21"></a>         <span class="at">change_1990_2040 =</span> <span class="fu">round</span>((pop_2040 <span class="sc">-</span> pop_1990) <span class="sc">/</span> pop_1990,<span class="dv">5</span>),</span>
<span id="cb3-22"><a href="#cb3-22"></a>         <span class="at">period =</span> <span class="fu">ifelse</span>(year <span class="sc">&lt;=</span> current_year, <span class="st">'past'</span>, <span class="st">'future'</span>),</span>
<span id="cb3-23"><a href="#cb3-23"></a>         <span class="at">trend =</span> <span class="fu">ifelse</span>(year <span class="sc">&lt;=</span> current_year, <span class="st">'past'</span>, </span>
<span id="cb3-24"><a href="#cb3-24"></a>                        <span class="fu">ifelse</span>(change_current_2040 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">'increase_future'</span>, <span class="st">'decrease_future'</span>))</span>
<span id="cb3-25"><a href="#cb3-25"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="visualization" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="visualization"><span class="header-section-number">2.2</span> Visualization</h3>
<p>After the data is ready, we assign values for the colors that will be used in the plots. Grey will be used for the period between 1990 and the current year, green for the future period if the population is projected to increase, and red if the opposite is true.</p>
<div class="cell">
<details class="code-fold">
<summary>Colors</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Define colors</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>color_past <span class="ot">&lt;-</span> <span class="st">'#7f7f7f'</span>  <span class="co"># Grey for the past (1990 to 2024)</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>color_increase_future <span class="ot">&lt;-</span> <span class="st">'#2ca02c'</span>  <span class="co"># Green for increasing in the future (2025 to 2040)</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>color_decrease_future <span class="ot">&lt;-</span> <span class="st">'#d62728'</span>  <span class="co"># Red for decreasing in the future (2025 to 2040)</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>mid_grey <span class="ot">&lt;-</span> <span class="st">'#b0b0b0'</span>  <span class="co"># Light grey for the vertical line</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>light_grey <span class="ot">&lt;-</span>  <span class="st">'#f5f5f5'</span> <span class="co"># Lighter grey for the label of the vertical line</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>At this point we are ready to create the function to produce the plots. This function consists of three parts: Creating a value for the placement of the current year line, creating the plot itself, and combining the plot with its annotations.</p>
<ul>
<li><strong>Part 1</strong> of the function creates <code>y_max</code>, a value to store the maximum value for the population of the municipality that will be plotted; once retrieved, we divide it by <code>1.02</code> to give it a little bit of room once it’s used to place the current year label on the plot.</li>
<li><strong>Part 2</strong> creates the actual plot. Perhaps the most important part of the plot is <code>scale_color_manual</code>, it is in this step where the color is assigned based on the behavior of the population of each municipality, i.e., will it grow or shrink in the future.</li>
<li><strong>Part 3</strong> combines the plot with its annotations. I choose to use patchwork, as opposed to adding these elements from within <code>ggplot2</code> because I might want to explore combining multiple municipalities in one single plot in the future.</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Plot Function</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Create a function to produce the plots</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>line_plot_function <span class="ot">&lt;-</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="cf">function</span>(</span>
<span id="cb5-4"><a href="#cb5-4"></a>    state_to_filter, <span class="co">#Since there are instances of municipalities with the same name, it's important to filter by State as well</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    mun_to_filter</span>
<span id="cb5-6"><a href="#cb5-6"></a>    ) {</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="co"># Part 1: This creates a max value for the y axis to place the label of the current year  </span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    y_max <span class="ot">&lt;-</span> pop <span class="sc">%&gt;%</span> </span>
<span id="cb5-9"><a href="#cb5-9"></a>        <span class="fu">filter</span>(state <span class="sc">==</span> state_to_filter) <span class="sc">%&gt;%</span> </span>
<span id="cb5-10"><a href="#cb5-10"></a>        <span class="fu">filter</span>(mun <span class="sc">==</span> mun_to_filter) <span class="sc">%&gt;%</span> </span>
<span id="cb5-11"><a href="#cb5-11"></a>        <span class="fu">slice_max</span>(</span>
<span id="cb5-12"><a href="#cb5-12"></a>          <span class="at">order_by =</span> total,</span>
<span id="cb5-13"><a href="#cb5-13"></a>          <span class="at">n =</span> <span class="dv">1</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb5-15"><a href="#cb5-15"></a>        <span class="fu">pull</span>(total)</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a>      y_max <span class="ot">&lt;-</span> y_max<span class="sc">/</span><span class="fl">1.02</span> <span class="co"># Reduce the value of y_max to better place the label</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>   </span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="co"># Part 2: This portion creates the plot itself, including a vertical line to denote the current year   </span></span>
<span id="cb5-20"><a href="#cb5-20"></a>     line_plot <span class="ot">&lt;-</span>  pop <span class="sc">%&gt;%</span> </span>
<span id="cb5-21"><a href="#cb5-21"></a>        <span class="fu">filter</span>(state <span class="sc">==</span> state_to_filter) <span class="sc">%&gt;%</span> </span>
<span id="cb5-22"><a href="#cb5-22"></a>        <span class="fu">filter</span>(mun <span class="sc">==</span> mun_to_filter) <span class="sc">%&gt;%</span> </span>
<span id="cb5-23"><a href="#cb5-23"></a>        <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> total, <span class="at">color =</span> trend)) <span class="sc">+</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>        <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>        <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb5-26"><a href="#cb5-26"></a>          <span class="st">'past'</span> <span class="ot">=</span> color_past,</span>
<span id="cb5-27"><a href="#cb5-27"></a>          <span class="st">'increase_future'</span> <span class="ot">=</span> color_increase_future,</span>
<span id="cb5-28"><a href="#cb5-28"></a>          <span class="st">'decrease_future'</span> <span class="ot">=</span> color_decrease_future</span>
<span id="cb5-29"><a href="#cb5-29"></a>        )) <span class="sc">+</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>        <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>        <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-32"><a href="#cb5-32"></a>        <span class="fu">theme</span>(</span>
<span id="cb5-33"><a href="#cb5-33"></a>          <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),  </span>
<span id="cb5-34"><a href="#cb5-34"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),  </span>
<span id="cb5-35"><a href="#cb5-35"></a>          <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">'#e5e5e5'</span>),</span>
<span id="cb5-36"><a href="#cb5-36"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">'grey95'</span>),</span>
<span id="cb5-37"><a href="#cb5-37"></a>          <span class="at">legend.position =</span> <span class="st">'none'</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>        ) <span class="sc">+</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> current_year, <span class="at">linetype =</span> <span class="st">'dashed'</span>, <span class="at">color =</span> mid_grey) <span class="sc">+</span></span>
<span id="cb5-40"><a href="#cb5-40"></a>        <span class="fu">annotate</span>(</span>
<span id="cb5-41"><a href="#cb5-41"></a>          <span class="at">geom =</span> <span class="st">'label'</span>,</span>
<span id="cb5-42"><a href="#cb5-42"></a>          <span class="at">x =</span> current_year<span class="dv">-2</span>,</span>
<span id="cb5-43"><a href="#cb5-43"></a>          <span class="at">y =</span> y_max,</span>
<span id="cb5-44"><a href="#cb5-44"></a>          <span class="at">label =</span> current_year,</span>
<span id="cb5-45"><a href="#cb5-45"></a>          <span class="at">fill =</span> mid_grey,</span>
<span id="cb5-46"><a href="#cb5-46"></a>          <span class="at">color =</span> light_grey,</span>
<span id="cb5-47"><a href="#cb5-47"></a>          <span class="at">label.size =</span> <span class="dv">0</span>,</span>
<span id="cb5-48"><a href="#cb5-48"></a>          <span class="at">label.padding =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">'lines'</span>)) <span class="sc">+</span></span>
<span id="cb5-49"><a href="#cb5-49"></a>        <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1990</span>, <span class="dv">2040</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb5-50"><a href="#cb5-50"></a>        <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma)</span>
<span id="cb5-51"><a href="#cb5-51"></a>     </span>
<span id="cb5-52"><a href="#cb5-52"></a>     <span class="co"># Part 3: Combine the plot with its annotations</span></span>
<span id="cb5-53"><a href="#cb5-53"></a>     line_plot <span class="sc">+</span></span>
<span id="cb5-54"><a href="#cb5-54"></a>       <span class="fu">plot_annotation</span>(</span>
<span id="cb5-55"><a href="#cb5-55"></a>         <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">'Population Trends in the Municipality of '</span>, mun_to_filter,<span class="st">', '</span>,state_to_filter,<span class="st">' (1990-2040)'</span>),</span>
<span id="cb5-56"><a href="#cb5-56"></a>         <span class="at">caption =</span> <span class="st">'Source: Reconstrucción y proyecciones de la población de los municipios de México 1990-2040, CONAPO, 2024</span><span class="sc">\n</span><span class="st">Plot: zer.ø Data Viz'</span>,</span>
<span id="cb5-57"><a href="#cb5-57"></a>         <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb5-58"><a href="#cb5-58"></a>           <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb5-59"><a href="#cb5-59"></a>           <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb5-60"><a href="#cb5-60"></a>           <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb5-61"><a href="#cb5-61"></a>         )</span>
<span id="cb5-62"><a href="#cb5-62"></a>       )</span>
<span id="cb5-63"><a href="#cb5-63"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="the-end-result" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="the-end-result"><span class="header-section-number">3</span> The End Result</h2>
<p>At last, now that all of the heavy-lifting is over, we test the function to see it in action.</p>
<div class="cell">
<details class="code-fold">
<summary>Test 01</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">line_plot_function</span>(<span class="st">'Jalisco'</span>, <span class="st">'Guadalajara'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03_pop_lines_files/figure-html/test-01-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, since the population of Guadalajara is decreasing, and it’s projected to continue doing so, the line for the future portion of the plot is red. When compared with Zapopan in the plot below, we can see a green line due to the expected growth in population in the future.</p>
<div class="cell">
<details class="code-fold">
<summary>Test 02</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">line_plot_function</span>(<span class="st">'Jalisco'</span>, <span class="st">'Zapopan'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03_pop_lines_files/figure-html/test-02-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="next-steps" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">4</span> Next Steps</h2>
<p>The beauty of this function is that it makes it incredibly easy to work in parametrized reports with speed and ease. It’s even possible to create a <code>for loop</code> that could automate the creation of a plot for every single municipality in Mexico.</p>
<p>One more idea I’d like to explore is the creation of plots that compare the behavior of multiple municipalities based on the size of their population in 1990 and see what happens to them across time; or the opposite, begin with municipalities with similar population in the future and backtrack to see how big or small they were in the past.</p>
<p>Time will tell what I do next with this script.</p>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb8" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">---</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="an">title:</span><span class="co"> "Population Trend Plots in ggplot2"</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="an">author:</span><span class="co"> "Juan Lozano Vallejo"</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="an">date:</span><span class="co"> "2024/08/23"</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="an">highlight-style:</span><span class="co"> pygments</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="an">format:</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">  html: </span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">    code-fold: true</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">    code-tools: true</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="co">    html-math-method: katex</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co">---</span></span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="fu">## Introduction</span></span>
<span id="cb8-17"><a href="#cb8-17"></a></span>
<span id="cb8-18"><a href="#cb8-18"></a>A couple of years ago I worked with <span class="co">[</span><span class="ot">CONAPO's population projections</span><span class="co">](https://www.gob.mx/conapo/documentos/reconstruccion-y-proyecciones-de-la-poblacion-de-los-municipios-de-mexico-1990-2040)</span> and found the process very slow and tedious because there wasn't or I couldn't find a good file to work with. Recently, I went back to the source and –probably because my search was better, or maybe they changed they files– found the information much more accessible this time around.</span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a>As I have been playing with the idea of creating reports for the municipalities of Mexico, after having edited the function for <span class="co">[</span><span class="ot">population pyramids</span><span class="co">](https://github.com/juanllave/mexico_pop/tree/main?tab=readme-ov-file)</span>, I decided that a good next step would be to create a line plot that visualizes the trends in the population per municipality from 1990 to 2040.</span>
<span id="cb8-21"><a href="#cb8-21"></a></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="fu">## The Process</span></span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="fu">### Gathering and Cleaning Data</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>As always, the fist step is to load the libraries and do some house cleaning.</span>
<span id="cb8-26"><a href="#cb8-26"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="in">```{r}</span></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="co">#| label: load-pkgs</span></span>
<span id="cb8-31"><a href="#cb8-31"></a><span class="co">#| code-summary: "Libraries"</span></span>
<span id="cb8-32"><a href="#cb8-32"></a><span class="co">#| cache: true</span></span>
<span id="cb8-33"><a href="#cb8-33"></a><span class="co">#| message: false</span></span>
<span id="cb8-34"><a href="#cb8-34"></a></span>
<span id="cb8-35"><a href="#cb8-35"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb8-36"><a href="#cb8-36"></a><span class="fu">library</span>(scales)</span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="fu">library</span>(readxl)</span>
<span id="cb8-38"><a href="#cb8-38"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb8-39"><a href="#cb8-39"></a></span>
<span id="cb8-40"><a href="#cb8-40"></a><span class="co"># Set working directory</span></span>
<span id="cb8-41"><a href="#cb8-41"></a><span class="fu">setwd</span>(<span class="st">'~/Documents/repos/R/mexico_pop'</span>)</span>
<span id="cb8-42"><a href="#cb8-42"></a>dir  <span class="ot">&lt;-</span> <span class="fu">getwd</span>()</span>
<span id="cb8-43"><a href="#cb8-43"></a><span class="in">```</span></span>
<span id="cb8-44"><a href="#cb8-44"></a></span>
<span id="cb8-45"><a href="#cb8-45"></a>Afterwards, we retrieve the data. Upon loading, we remove unnecessary columns from the original dataset using select. The columns we are removing present the data by age groups, if we wished to create more complex plots that show the population changing by this measure, we could leave them, but for now, these will not be necessary.</span>
<span id="cb8-46"><a href="#cb8-46"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a><span class="in">```{r}</span></span>
<span id="cb8-50"><a href="#cb8-50"></a><span class="co">#| label: load-data</span></span>
<span id="cb8-51"><a href="#cb8-51"></a><span class="co">#| code-summary: "Load Data"</span></span>
<span id="cb8-52"><a href="#cb8-52"></a><span class="co">#| cache: true</span></span>
<span id="cb8-53"><a href="#cb8-53"></a><span class="co">#| message: false</span></span>
<span id="cb8-54"><a href="#cb8-54"></a></span>
<span id="cb8-55"><a href="#cb8-55"></a><span class="co"># Load dataset with the population per municipality, age groups, and sex</span></span>
<span id="cb8-56"><a href="#cb8-56"></a>data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">paste0</span>(dir,<span class="st">'/datasets/1_Grupo_Quinq_00_RM.xlsx'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-57"><a href="#cb8-57"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="dv">7</span><span class="sc">:</span><span class="dv">24</span>))</span>
<span id="cb8-58"><a href="#cb8-58"></a><span class="in">```</span></span>
<span id="cb8-59"><a href="#cb8-59"></a></span>
<span id="cb8-60"><a href="#cb8-60"></a>Once we have the data, we need to make a few adjustments, remove some columns and create new ones to be able to produce the plots.But before doing so, we need to create the variable <span class="in">`curent year`</span> to store the value of the present year, this will future-proof the plots.</span>
<span id="cb8-61"><a href="#cb8-61"></a></span>
<span id="cb8-62"><a href="#cb8-62"></a>One more change we do before proceeding with the actual cleaning of the dataset, is translating the columns names from Spanish into English. For this, we create a vector with the new names for the columns and we change the names of the columns.</span>
<span id="cb8-63"><a href="#cb8-63"></a></span>
<span id="cb8-64"><a href="#cb8-64"></a>We are now ready to clean the dataset. Since the data is separated by women and men, and we need the total, we group the data and then summarize to have one value per municipality and per year. Next, we create columns with the population total for 1990, the current year, and 2040. These are immediately used to compute the percent change between 1990 and the current year, between 2040 and the current year, and between 1990 and 2040. Lastly, we create the columns *period* and *trend*, these will be helpful to choose the colors for the plots.</span>
<span id="cb8-65"><a href="#cb8-65"></a></span>
<span id="cb8-66"><a href="#cb8-66"></a><span class="in">````{r}</span></span>
<span id="cb8-67"><a href="#cb8-67"></a><span class="in">#| label: clean-up</span></span>
<span id="cb8-68"><a href="#cb8-68"></a><span class="in">#| code-summary: "Clean-up"</span></span>
<span id="cb8-69"><a href="#cb8-69"></a><span class="in">#| cache: true</span></span>
<span id="cb8-70"><a href="#cb8-70"></a><span class="in">#| message: false</span></span>
<span id="cb8-71"><a href="#cb8-71"></a></span>
<span id="cb8-72"><a href="#cb8-72"></a><span class="in"># Create a value with the current year</span></span>
<span id="cb8-73"><a href="#cb8-73"></a><span class="in">current_year &lt;- as.numeric(format(Sys.Date(), "%Y"))</span></span>
<span id="cb8-74"><a href="#cb8-74"></a></span>
<span id="cb8-75"><a href="#cb8-75"></a><span class="in"># Create a vector to translate columns names into English</span></span>
<span id="cb8-76"><a href="#cb8-76"></a><span class="in">columns &lt;- c('key', 'key_state', 'state', 'mun', 'sex', 'year', 'total')</span></span>
<span id="cb8-77"><a href="#cb8-77"></a></span>
<span id="cb8-78"><a href="#cb8-78"></a><span class="in"># Change the columns names</span></span>
<span id="cb8-79"><a href="#cb8-79"></a><span class="in">colnames(data) &lt;- columns</span></span>
<span id="cb8-80"><a href="#cb8-80"></a></span>
<span id="cb8-81"><a href="#cb8-81"></a><span class="in"># Prepare the data for the plots</span></span>
<span id="cb8-82"><a href="#cb8-82"></a><span class="in">pop &lt;- data %&gt;% </span></span>
<span id="cb8-83"><a href="#cb8-83"></a><span class="in">  group_by(key, key_state, state, mun, year) %&gt;% </span></span>
<span id="cb8-84"><a href="#cb8-84"></a><span class="in">  summarise(total = sum(total)) %&gt;% </span></span>
<span id="cb8-85"><a href="#cb8-85"></a><span class="in">  group_by(key) %&gt;%</span></span>
<span id="cb8-86"><a href="#cb8-86"></a><span class="in">  mutate(</span></span>
<span id="cb8-87"><a href="#cb8-87"></a><span class="in">    pop_1990 = total[year == 1990],</span></span>
<span id="cb8-88"><a href="#cb8-88"></a><span class="in">         pop_current = total[year == current_year],</span></span>
<span id="cb8-89"><a href="#cb8-89"></a><span class="in">         pop_2040 = total[year == 2040],</span></span>
<span id="cb8-90"><a href="#cb8-90"></a><span class="in">         change_1990_current = round((pop_current - pop_1990) / pop_1990,5),</span></span>
<span id="cb8-91"><a href="#cb8-91"></a><span class="in">         change_current_2040 = round((pop_2040 - pop_current) / pop_current,5),</span></span>
<span id="cb8-92"><a href="#cb8-92"></a><span class="in">         change_1990_2040 = round((pop_2040 - pop_1990) / pop_1990,5),</span></span>
<span id="cb8-93"><a href="#cb8-93"></a><span class="in">         period = ifelse(year &lt;= current_year, 'past', 'future'),</span></span>
<span id="cb8-94"><a href="#cb8-94"></a><span class="in">         trend = ifelse(year &lt;= current_year, 'past', </span></span>
<span id="cb8-95"><a href="#cb8-95"></a><span class="in">                        ifelse(change_current_2040 &gt; 0, 'increase_future', 'decrease_future'))</span></span>
<span id="cb8-96"><a href="#cb8-96"></a><span class="in">    )</span></span>
<span id="cb8-97"><a href="#cb8-97"></a><span class="in">````</span></span>
<span id="cb8-98"><a href="#cb8-98"></a></span>
<span id="cb8-99"><a href="#cb8-99"></a><span class="fu">### Visualization</span></span>
<span id="cb8-100"><a href="#cb8-100"></a></span>
<span id="cb8-101"><a href="#cb8-101"></a>After the data is ready, we assign values for the colors that will be used in the plots. Grey will be used for the period between 1990 and the current year, green for the future period if the population is projected to increase, and red if the opposite is true.</span>
<span id="cb8-102"><a href="#cb8-102"></a></span>
<span id="cb8-103"><a href="#cb8-103"></a><span class="in">````{r}</span></span>
<span id="cb8-104"><a href="#cb8-104"></a><span class="in">#| label: colors</span></span>
<span id="cb8-105"><a href="#cb8-105"></a><span class="in">#| code-summary: "Colors"</span></span>
<span id="cb8-106"><a href="#cb8-106"></a><span class="in">#| cache: true</span></span>
<span id="cb8-107"><a href="#cb8-107"></a><span class="in">#| message: false</span></span>
<span id="cb8-108"><a href="#cb8-108"></a></span>
<span id="cb8-109"><a href="#cb8-109"></a><span class="in"># Define colors</span></span>
<span id="cb8-110"><a href="#cb8-110"></a><span class="in">color_past &lt;- '#7f7f7f'  # Grey for the past (1990 to 2024)</span></span>
<span id="cb8-111"><a href="#cb8-111"></a><span class="in">color_increase_future &lt;- '#2ca02c'  # Green for increasing in the future (2025 to 2040)</span></span>
<span id="cb8-112"><a href="#cb8-112"></a><span class="in">color_decrease_future &lt;- '#d62728'  # Red for decreasing in the future (2025 to 2040)</span></span>
<span id="cb8-113"><a href="#cb8-113"></a><span class="in">mid_grey &lt;- '#b0b0b0'  # Light grey for the vertical line</span></span>
<span id="cb8-114"><a href="#cb8-114"></a><span class="in">light_grey &lt;-  '#f5f5f5' # Lighter grey for the label of the vertical line</span></span>
<span id="cb8-115"><a href="#cb8-115"></a><span class="in">````</span></span>
<span id="cb8-116"><a href="#cb8-116"></a></span>
<span id="cb8-117"><a href="#cb8-117"></a></span>
<span id="cb8-118"><a href="#cb8-118"></a>At this point we are ready to create the function to produce the plots. This function consists of three parts: Creating a value for the placement of the current year line, creating the plot itself, and combining the plot with its annotations.</span>
<span id="cb8-119"><a href="#cb8-119"></a></span>
<span id="cb8-120"><a href="#cb8-120"></a><span class="ss">+ </span>**Part 1** of the function creates <span class="in">`y_max`</span>, a value to store the maximum value for the population of the municipality that will be plotted; once retrieved, we divide it by <span class="in">`1.02`</span> to give it a little bit of room once it's used to place the current year label on the plot.</span>
<span id="cb8-121"><a href="#cb8-121"></a><span class="ss">+ </span>**Part 2** creates the actual plot. Perhaps the most important part of the plot is <span class="in">`scale_color_manual`</span>, it is in this step where the color is assigned based on the behavior of the population of each municipality, i.e., will it grow or shrink in the future.</span>
<span id="cb8-122"><a href="#cb8-122"></a><span class="ss">+ </span>**Part 3** combines the plot with its annotations. I choose to use patchwork, as opposed to adding these elements from within <span class="in">`ggplot2`</span> because I might want to explore combining multiple municipalities in one single plot in the future.</span>
<span id="cb8-123"><a href="#cb8-123"></a></span>
<span id="cb8-124"><a href="#cb8-124"></a><span class="in">````{r}</span></span>
<span id="cb8-125"><a href="#cb8-125"></a><span class="in">#| label: plot-function</span></span>
<span id="cb8-126"><a href="#cb8-126"></a><span class="in">#| code-summary: "Plot Function"</span></span>
<span id="cb8-127"><a href="#cb8-127"></a><span class="in">#| cache: true</span></span>
<span id="cb8-128"><a href="#cb8-128"></a><span class="in">#| message: false</span></span>
<span id="cb8-129"><a href="#cb8-129"></a></span>
<span id="cb8-130"><a href="#cb8-130"></a><span class="in"># Create a function to produce the plots</span></span>
<span id="cb8-131"><a href="#cb8-131"></a><span class="in">line_plot_function &lt;-</span></span>
<span id="cb8-132"><a href="#cb8-132"></a><span class="in">  function(</span></span>
<span id="cb8-133"><a href="#cb8-133"></a><span class="in">    state_to_filter, #Since there are instances of municipalities with the same name, it's important to filter by State as well</span></span>
<span id="cb8-134"><a href="#cb8-134"></a><span class="in">    mun_to_filter</span></span>
<span id="cb8-135"><a href="#cb8-135"></a><span class="in">    ) {</span></span>
<span id="cb8-136"><a href="#cb8-136"></a><span class="in">    # Part 1: This creates a max value for the y axis to place the label of the current year  </span></span>
<span id="cb8-137"><a href="#cb8-137"></a><span class="in">    y_max &lt;- pop %&gt;% </span></span>
<span id="cb8-138"><a href="#cb8-138"></a><span class="in">        filter(state == state_to_filter) %&gt;% </span></span>
<span id="cb8-139"><a href="#cb8-139"></a><span class="in">        filter(mun == mun_to_filter) %&gt;% </span></span>
<span id="cb8-140"><a href="#cb8-140"></a><span class="in">        slice_max(</span></span>
<span id="cb8-141"><a href="#cb8-141"></a><span class="in">          order_by = total,</span></span>
<span id="cb8-142"><a href="#cb8-142"></a><span class="in">          n = 1</span></span>
<span id="cb8-143"><a href="#cb8-143"></a><span class="in">        ) %&gt;% </span></span>
<span id="cb8-144"><a href="#cb8-144"></a><span class="in">        pull(total)</span></span>
<span id="cb8-145"><a href="#cb8-145"></a></span>
<span id="cb8-146"><a href="#cb8-146"></a><span class="in">      y_max &lt;- y_max/1.02 # Reduce the value of y_max to better place the label</span></span>
<span id="cb8-147"><a href="#cb8-147"></a><span class="in">   </span></span>
<span id="cb8-148"><a href="#cb8-148"></a><span class="in">    # Part 2: This portion creates the plot itself, including a vertical line to denote the current year   </span></span>
<span id="cb8-149"><a href="#cb8-149"></a><span class="in">     line_plot &lt;-  pop %&gt;% </span></span>
<span id="cb8-150"><a href="#cb8-150"></a><span class="in">        filter(state == state_to_filter) %&gt;% </span></span>
<span id="cb8-151"><a href="#cb8-151"></a><span class="in">        filter(mun == mun_to_filter) %&gt;% </span></span>
<span id="cb8-152"><a href="#cb8-152"></a><span class="in">        ggplot(aes(x = year, y = total, color = trend)) +</span></span>
<span id="cb8-153"><a href="#cb8-153"></a><span class="in">        geom_line(linewidth = 1) +</span></span>
<span id="cb8-154"><a href="#cb8-154"></a><span class="in">        scale_color_manual(values = c(</span></span>
<span id="cb8-155"><a href="#cb8-155"></a><span class="in">          'past' = color_past,</span></span>
<span id="cb8-156"><a href="#cb8-156"></a><span class="in">          'increase_future' = color_increase_future,</span></span>
<span id="cb8-157"><a href="#cb8-157"></a><span class="in">          'decrease_future' = color_decrease_future</span></span>
<span id="cb8-158"><a href="#cb8-158"></a><span class="in">        )) +</span></span>
<span id="cb8-159"><a href="#cb8-159"></a><span class="in">        theme_minimal() +</span></span>
<span id="cb8-160"><a href="#cb8-160"></a><span class="in">        theme_minimal() +</span></span>
<span id="cb8-161"><a href="#cb8-161"></a><span class="in">        theme(</span></span>
<span id="cb8-162"><a href="#cb8-162"></a><span class="in">          axis.title.x = element_blank(),  </span></span>
<span id="cb8-163"><a href="#cb8-163"></a><span class="in">          axis.title.y = element_blank(),  </span></span>
<span id="cb8-164"><a href="#cb8-164"></a><span class="in">          panel.grid.major = element_line(color = '#e5e5e5'),</span></span>
<span id="cb8-165"><a href="#cb8-165"></a><span class="in">          panel.grid.minor = element_line(color = 'grey95'),</span></span>
<span id="cb8-166"><a href="#cb8-166"></a><span class="in">          legend.position = 'none'</span></span>
<span id="cb8-167"><a href="#cb8-167"></a><span class="in">        ) +</span></span>
<span id="cb8-168"><a href="#cb8-168"></a><span class="in">        geom_vline(xintercept = current_year, linetype = 'dashed', color = mid_grey) +</span></span>
<span id="cb8-169"><a href="#cb8-169"></a><span class="in">        annotate(</span></span>
<span id="cb8-170"><a href="#cb8-170"></a><span class="in">          geom = 'label',</span></span>
<span id="cb8-171"><a href="#cb8-171"></a><span class="in">          x = current_year-2,</span></span>
<span id="cb8-172"><a href="#cb8-172"></a><span class="in">          y = y_max,</span></span>
<span id="cb8-173"><a href="#cb8-173"></a><span class="in">          label = current_year,</span></span>
<span id="cb8-174"><a href="#cb8-174"></a><span class="in">          fill = mid_grey,</span></span>
<span id="cb8-175"><a href="#cb8-175"></a><span class="in">          color = light_grey,</span></span>
<span id="cb8-176"><a href="#cb8-176"></a><span class="in">          label.size = 0,</span></span>
<span id="cb8-177"><a href="#cb8-177"></a><span class="in">          label.padding = unit(0.3, 'lines')) +</span></span>
<span id="cb8-178"><a href="#cb8-178"></a><span class="in">        scale_x_continuous(breaks = seq(1990, 2040, 5)) +</span></span>
<span id="cb8-179"><a href="#cb8-179"></a><span class="in">        scale_y_continuous(labels = scales::comma)</span></span>
<span id="cb8-180"><a href="#cb8-180"></a><span class="in">     </span></span>
<span id="cb8-181"><a href="#cb8-181"></a><span class="in">     # Part 3: Combine the plot with its annotations</span></span>
<span id="cb8-182"><a href="#cb8-182"></a><span class="in">     line_plot +</span></span>
<span id="cb8-183"><a href="#cb8-183"></a><span class="in">       plot_annotation(</span></span>
<span id="cb8-184"><a href="#cb8-184"></a><span class="in">         title = paste0('Population Trends in the Municipality of ', mun_to_filter,', ',state_to_filter,' (1990-2040)'),</span></span>
<span id="cb8-185"><a href="#cb8-185"></a><span class="in">         caption = 'Source: Reconstrucción y proyecciones de la población de los municipios de México 1990-2040, CONAPO, 2024\nPlot: zer.ø Data Viz',</span></span>
<span id="cb8-186"><a href="#cb8-186"></a><span class="in">         theme = theme(</span></span>
<span id="cb8-187"><a href="#cb8-187"></a><span class="in">           plot.title = element_text(hjust = 0, size = 14, face = "bold"),</span></span>
<span id="cb8-188"><a href="#cb8-188"></a><span class="in">           plot.subtitle = element_text(hjust = 0, size = 12),</span></span>
<span id="cb8-189"><a href="#cb8-189"></a><span class="in">           plot.caption = element_text(hjust = 0, size = 8)</span></span>
<span id="cb8-190"><a href="#cb8-190"></a><span class="in">         )</span></span>
<span id="cb8-191"><a href="#cb8-191"></a><span class="in">       )</span></span>
<span id="cb8-192"><a href="#cb8-192"></a><span class="in">    }</span></span>
<span id="cb8-193"><a href="#cb8-193"></a><span class="in">````</span></span>
<span id="cb8-194"><a href="#cb8-194"></a></span>
<span id="cb8-195"><a href="#cb8-195"></a><span class="fu">## The End Result</span></span>
<span id="cb8-196"><a href="#cb8-196"></a></span>
<span id="cb8-197"><a href="#cb8-197"></a>At last, now that all of the heavy-lifting is over, we test the function to see it in action.</span>
<span id="cb8-198"><a href="#cb8-198"></a></span>
<span id="cb8-199"><a href="#cb8-199"></a><span class="in">````{r}</span></span>
<span id="cb8-200"><a href="#cb8-200"></a><span class="in">#| label: test-01</span></span>
<span id="cb8-201"><a href="#cb8-201"></a><span class="in">#| code-summary: "Test 01"</span></span>
<span id="cb8-202"><a href="#cb8-202"></a><span class="in">#| message: true</span></span>
<span id="cb8-203"><a href="#cb8-203"></a></span>
<span id="cb8-204"><a href="#cb8-204"></a><span class="in">line_plot_function('Jalisco', 'Guadalajara')</span></span>
<span id="cb8-205"><a href="#cb8-205"></a><span class="in">````</span></span>
<span id="cb8-206"><a href="#cb8-206"></a></span>
<span id="cb8-207"><a href="#cb8-207"></a>As we can see, since the population of Guadalajara is decreasing, and it's projected to continue doing so, the line for the future portion of the plot is red. When compared with Zapopan in the plot below, we can see a green line due to the expected growth in population in the future.</span>
<span id="cb8-208"><a href="#cb8-208"></a></span>
<span id="cb8-209"><a href="#cb8-209"></a><span class="in">````{r}</span></span>
<span id="cb8-210"><a href="#cb8-210"></a><span class="in">#| label: test-02</span></span>
<span id="cb8-211"><a href="#cb8-211"></a><span class="in">#| code-summary: "Test 02"</span></span>
<span id="cb8-212"><a href="#cb8-212"></a><span class="in">#| message: true</span></span>
<span id="cb8-213"><a href="#cb8-213"></a></span>
<span id="cb8-214"><a href="#cb8-214"></a><span class="in">line_plot_function('Jalisco', 'Zapopan')</span></span>
<span id="cb8-215"><a href="#cb8-215"></a><span class="in">````</span></span>
<span id="cb8-216"><a href="#cb8-216"></a></span>
<span id="cb8-217"><a href="#cb8-217"></a><span class="fu">## Next Steps</span></span>
<span id="cb8-218"><a href="#cb8-218"></a></span>
<span id="cb8-219"><a href="#cb8-219"></a>The beauty of this function is that it makes it incredibly easy to work in parametrized reports with speed and ease. It's even possible to create a <span class="in">`for loop`</span> that could automate the creation of a plot for every single municipality in Mexico.</span>
<span id="cb8-220"><a href="#cb8-220"></a></span>
<span id="cb8-221"><a href="#cb8-221"></a>One more idea I'd like to explore is the creation of plots that compare the behavior of multiple municipalities based on the size of their population in 1990 and see what happens to them across time; or the opposite, begin with municipalities with similar population in the future and backtrack to see how big or small they were in the past.</span>
<span id="cb8-222"><a href="#cb8-222"></a></span>
<span id="cb8-223"><a href="#cb8-223"></a>Time will tell what I do next with this script.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>